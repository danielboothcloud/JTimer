name: Build and Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Swift
        run: |
          swift --version
          xcodebuild -version

      - name: Read version from VERSION file
        id: version
        run: |
          VERSION=$(cat VERSION 2>/dev/null || echo "1.0.0")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

      - name: Build app bundle
        run: |
          chmod +x build-app.sh
          ./build-app.sh

      - name: Create ZIP archive
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ZIP_FILE="JTimer-${VERSION}.zip"

          # Create zip with app
          ditto -c -k --keepParent JTimer.app "${ZIP_FILE}"

          echo "Created ${ZIP_FILE}"
          ls -lh "${ZIP_FILE}"

      - name: Upload ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: JTimer-${{ steps.version.outputs.version }}
          path: JTimer-${{ steps.version.outputs.version }}.zip
          retention-days: 90

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          ZIP_FILE="JTimer-${VERSION}.zip"
          COMMIT_SHA=$(git rev-parse --short HEAD)

          # Determine release tag
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            RELEASE_TAG="v${VERSION}"
            RELEASE_TITLE="JTimer v${VERSION}"
          else
            RELEASE_TAG="v${VERSION}"
            RELEASE_TITLE="JTimer v${VERSION}"
          fi

          # Delete existing release with this tag if it exists
          gh release delete "${RELEASE_TAG}" --yes 2>/dev/null || true

          gh release create "${RELEASE_TAG}" \
            "${ZIP_FILE}" \
            --title "${RELEASE_TITLE}" \
            --notes "## JTimer v${VERSION}

          **Build:** ${COMMIT_SHA}

          ### Installation

          **If you see a \"damaged\" or \"unidentified developer\" warning:**

          1. Download the ZIP file below and extract it
          2. Open **Terminal** and run:
             \`\`\`bash
             xattr -cr ~/Downloads/JTimer.app
             # Or if you moved it to Applications:
             xattr -cr /Applications/JTimer.app
             \`\`\`
          3. Launch JTimer from Applications or Spotlight

          **Standard Installation (if no warning):**

          1. Download and extract the ZIP file
          2. Move JTimer.app to your Applications folder
          3. Launch JTimer from Applications or Spotlight

          ### What's Changed
          See commit history for details.

          ---

          *Note: This app is ad-hoc signed. The xattr command removes macOS quarantine attributes from downloaded files.*" \
            --draft=false \
            --prerelease=false \
            --latest=true
